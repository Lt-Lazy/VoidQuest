<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Top-Down Game</title>
  
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000000;
    }

    #gameCanvas {
      background: #252525;
      border: 4px solid #444;
      image-rendering: pixelated;
    }

    #fishingBox button {
      margin: 5px;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <canvas id="gameCanvas"></canvas>
  <div id="inventory" style="display:none; position:absolute; top:50px; left:50px; background:#222; padding:10px; border:2px solid #555; z-index:15;"></div>
  <div id="shopBox" style="display:none; position:absolute; bottom:50px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px; border:2px solid #aaa; font-family:monospace; z-index:10;"></div>


  <div id="gameMenu" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:20; color:white; font-family:sans-serif; align-items:center; justify-content:center; flex-direction:column; gap:20px;">
    <button onclick="closeMenu()" style="font-size:24px; padding:10px 20px;">Fortsett</button>
    <button onclick="saveGame()" style="font-size:24px; padding:10px 20px;">Lagre spill</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const tileSize = 40;

    let menuOpen = false;

    // === Tiles ===
    const tileImages = {
      grass: new Image(),
      coblestone: new Image(),
      tree: new Image(),
      brick: new Image(),
      plank: new Image(),
      fence: new Image(),
      table: new Image(),
      door: new Image(),
      water: new Image(),
      sand: new Image(),
      stoneSingle: new Image(),
      npcShop: new Image()
    };

    tileImages.grass.src = 'images/grassTile.png';
    tileImages.tree.src = 'images/treeTile.png';
    tileImages.brick.src = 'images/brickTile.png';
    tileImages.plank.src = 'images/plankTile.png';
    tileImages.door.src = 'images/doorTile.png';
    tileImages.fence.src = 'images/fenceTile.png';
    tileImages.table.src = 'images/tableTile.png';
    tileImages.coblestone.src = 'images/coblestoneTile.png';
    tileImages.water.src = 'images/waterTile.png';
    tileImages.npcShop.src = 'images/npcShopTile.png';
    tileImages.sand.src = 'images/sandTile.png';
    tileImages.stoneSingle.src = 'images/stoneSingleTile.png';

    const tileMapping = {
      'G': 'grass',
      'C': 'coblestone',
      'T': 'tree',
      'B': 'brick',
      'P': 'plank',
      'F': 'fence',
      't': 'table',
      'D': 'door',
      'W': 'water',
      'S': 'sand',
      's': 'stoneSingle',
      'N': 'npcShop'
    };

    const nonWalkableTiles = ['tree', 'brick', 'fence', 'table', 'water', 'stoneSingle'];

    const characterImages = {
      up: new Image(),
      down: new Image(),
      left: new Image(),
      right: new Image(),
    };

    characterImages.up.src = 'images/pixelmannUp.png';
    characterImages.down.src = 'images/pixelmanndown.png';
    characterImages.left.src = 'images/pixelmannLeft.png';
    characterImages.right.src = 'images/pixelmannRight.png';

    const character = {
      x: 0, y: 0,
      pixelX: 0, pixelY: 0,
      direction: 'down',
      moving: false
    };

    const keys = { w: false, a: false, s: false, d: false };

    const doorMap = {
      0: {
        '2,9': { targetLevel: 1, targetX: 10, targetY: 2 },     // TIL HUS
        '22,3': { targetLevel: 2, targetX: 5, targetY: 1 }      // TIL CAVE
      },
      1: {
        '10,1': { targetLevel: 0, targetX: 3, targetY: 10 }     // TIL UTE
      },
      2: {
        '5,0': { targetLevel: 0, targetX: 22, targetY: 4 }      // TIL UTE
      }
    };

    const levels = [
      {
        layout: [
          'GGGGGGGGGGGGGGGGGGsCCCCC',
          'GGGGGGGGGGGGGGGGGGGsCCCC',
          'GGTTGGGGGGGGGGGGGGGsCCCC',
          'GGGGGGGGGGGGGGGGGGGGsCDC',
          'GGGGTGGTGGGGGGGGGGGGGsGs',
          'GGGGGGGGGGGGGGGGGGGGGGGG',
          'GGBBGGGGGGGGGGGGGGGGGGGG',
          'GBBBBGTTGGGGGGGGGGGGGGGG',
          'GBBBBTTTTTTGGGGGGGGGSSSS',
          'GBDBBFFFFFGGGGGGGGGSWWWW',
          'GGGGGGGGGGGGGGGGGGSWWWWW',
          'GGGGGGGGGGGGGGGGGSWWWWWW'
        ],
        startX: 4,
        startY: 10,
        background: 'grass'
      },
      {
        layout: [
          'BBBBBBBBBBBB',
          'BBBBBBBBBBDB',
          'BPNPPPPPPPPB',
          'BtttPPPPPPPB',
          'BPPPPPPPPPPB',
          'BPPPPPPPPPPB',
          'BPPPPPPPPPPB',
          'BPPPPPPPPPPB'
        ],
        startX: 5,
        startY: 5,
        background: 'plank'
      },
      {
        layout: [
          'CCsssDssCsWW',
          'CsCssCCsCCsW',
          'CsCCCCCCCCCC',
          'CCCsCCCCCCsC',
          'CsCsssCCCCsC',
          'CCCCsCCssCsC',
          'CCCCsCCCCCsC',
          'CCCCsCCCCCCC'
        ],
        startX: 5,
        startY: 5,
        background: 'coblestone'
      }
    ];

    let currentLevel = 0, map = [], mapWidth = 0, mapHeight = 0;
    let currentBackground = 'grass';

    let isFishing = false;
    let fishingBox = null;
    let fishTimeout = null;
    let biteTimeout = null;
    let currentFish = null;
    let fishCaught = false;

    let inventory = [];
    let inventoryOpen = false;
    let gold = 0;

    function loadLevel(levelIndex, startX = null, startY = null) {
        const level = levels[levelIndex];
        currentLevel = levelIndex;

        map = level.layout.map(row => row.split('').map(char => tileMapping[char]));
        mapHeight = map.length;
        mapWidth = map[0].length;

        canvas.width = mapWidth * tileSize;
        canvas.height = mapHeight * tileSize;

        currentBackground = level.background || 'grass';

        character.x = startX !== null ? startX : level.startX;
        character.y = startY !== null ? startY : level.startY;

        character.pixelX = character.x * tileSize;
        character.pixelY = character.y * tileSize;

        gameLoop();
    }

    function drawMap() {
      for (let y = 0; y < mapHeight; y++) {
        for (let x = 0; x < mapWidth; x++) {
          const tileType = map[y][x];
          ctx.drawImage(tileImages[currentBackground], x * tileSize, y * tileSize, tileSize, tileSize);
          if (tileType !== 'grass') {
            ctx.drawImage(tileImages[tileType], x * tileSize, y * tileSize, tileSize, tileSize);
          }
        }
      }
    }

    function drawCharacter() {
      const img = characterImages[character.direction];
      ctx.drawImage(img, character.pixelX, character.pixelY, tileSize, tileSize);
    }

    function canMoveTo(x, y) {
      if (x < 0 || y < 0 || x >= mapWidth || y >= mapHeight) return false;
      return !nonWalkableTiles.includes(map[y][x]);
    }

    function moveCharacter(dx, dy) {
      if (character.moving) return;

      const newX = character.x + dx;
      const newY = character.y + dy;
      if (!canMoveTo(newX, newY)) return;

      character.direction = dx === -1 ? 'left' : dx === 1 ? 'right' : dy === -1 ? 'up' : 'down';
      character.moving = true;
      character.x = newX;
      character.y = newY;

      const targetX = character.x * tileSize;
      const targetY = character.y * tileSize;
      const speed = 2;

      function animate() {
        let doneX = false, doneY = false;
        if (character.pixelX < targetX) {
          character.pixelX += speed;
          if (character.pixelX >= targetX) { character.pixelX = targetX; doneX = true; }
        } else if (character.pixelX > targetX) {
          character.pixelX -= speed;
          if (character.pixelX <= targetX) { character.pixelX = targetX; doneX = true; }
        } else { doneX = true; }

        if (character.pixelY < targetY) {
          character.pixelY += speed;
          if (character.pixelY >= targetY) { character.pixelY = targetY; doneY = true; }
        } else if (character.pixelY > targetY) {
          character.pixelY -= speed;
          if (character.pixelY <= targetY) { character.pixelY = targetY; doneY = true; }
        } else { doneY = true; }

        gameLoop();

        if (!doneX || !doneY) {
          requestAnimationFrame(animate);
        } else {
          character.moving = false;
          const tile = map[character.y][character.x];
          if (tile === 'door') {
            const key = `${character.x},${character.y}`;
            const door = doorMap[currentLevel]?.[key];
            if (door) loadLevel(door.targetLevel, door.targetX, door.targetY);
          }
        }
      }

      requestAnimationFrame(animate);
    }

    function tryInteract() {
      if (character.moving || isFishing) return;
      let tx = character.x, ty = character.y;
      if (character.direction === 'up') ty -= 1;
      if (character.direction === 'down') ty += 1;
      if (character.direction === 'left') tx -= 1;
      if (character.direction === 'right') tx += 1;
      const tile = map[ty]?.[tx];
      if (tile === 'water') startFishing();
      else if (tile === 'npcShop') openShop();
    }

    function startFishing() {
      isFishing = true;
      fishCaught = false;
      showFishingBox("Fisker...");
      const wait = Math.floor(Math.random() * 10000) + 5000;
      fishTimeout = setTimeout(fishGotBite, wait);
    }

    function showFishingBox(text) {
      if (!fishingBox) {
        fishingBox = document.createElement('div');
        fishingBox.id = 'fishingBox';
        fishingBox.style.position = 'absolute';
        fishingBox.style.bottom = '50px';
        fishingBox.style.left = '50%';
        fishingBox.style.transform = 'translateX(-50%)';
        fishingBox.style.background = '#333';
        fishingBox.style.color = '#fff';
        fishingBox.style.padding = '10px';
        fishingBox.style.border = '2px solid #aaa';
        fishingBox.style.fontFamily = 'monospace';
        fishingBox.style.zIndex = '10';
        document.body.appendChild(fishingBox);
      }
      fishingBox.innerHTML = `${text}<br><button onclick="cancelFishing()">Avbryt</button>`;
    }

    function hideFishingBox() {
      if (fishingBox) {
        document.body.removeChild(fishingBox);
        fishingBox = null;
      }
    }

    function cancelFishing() {
      clearTimeout(fishTimeout);
      clearTimeout(biteTimeout);
      hideFishingBox();
      isFishing = false;
    }

    function fishGotBite() {
      currentFish = getRandomFish();
      const rarity = currentFish.rarity;

      const prompt = `
        <div style="margin-bottom: 10px;">
          <img src="${currentFish.image}" width="64" height="64" alt="${currentFish.name}">
          <div>${currentFish.name}</div>
        </div>
        <div style="margin-bottom: 10px;">NAPP! Trykk riktig knapp:</div>
        <button style="background:gray;" onclick="tryCatchFish('common')">Common</button>
        <button style="background:blue;" onclick="tryCatchFish('rare')">Rare</button>
        <button style="background:gold;" onclick="tryCatchFish('legendary')">Legendary</button>
        <br><br><button onclick="cancelFishing()">Avbryt</button>
      `;
      fishingBox.innerHTML = prompt;

      biteTimeout = setTimeout(() => {
        if (!fishCaught) {
          showFishingBox("Fisken stakk av!");
          setTimeout(cancelFishing, 2000);
        }
      }, 3000);
    }

    function tryCatchFish(choice) {
      if (currentFish && currentFish.rarity === choice) {
        showFishingBox(`Du fanget en ${currentFish.name}!`);
        addToInventory(currentFish);
      } else {
        showFishingBox("Bom! Du mistet fisken.");
      }
      fishCaught = true;
      setTimeout(cancelFishing, 2000);
    }

    function getRandomFish() {
      const roll = Math.random() * 100;

      if (roll < 78) {
        return { name: "Common fisk", rarity: "common", image: "images/commonFish.png" };
      } else if (roll < 98) {
        return { name: "Rare fisk", rarity: "rare", image: "images/rareFish.png" };
      } else {
        return { name: "Legendary fisk", rarity: "legendary", image: "images/legendaryFish.png" };
      }
    }

    function addToInventory(fish) {
      let item = inventory.find(i => i.name === fish.name);
      if (item) {
        item.count += 1;
      } else {
        inventory.push({ ...fish, count: 1 });
      }
      if (inventoryOpen) renderInventory();
    }

    function openShop() {
      const shopBox = document.getElementById('shopBox');
      let shopHTML = `<h3>Butikk</h3><p>Selg fisken din for gull</p>`;

      const sellOptions = [
        { rarity: 'common', label: 'Common fisk', price: 5 },
        { rarity: 'rare', label: 'Rare fisk', price: 30 },
        { rarity: 'legendary', label: 'Legendary fisk', price: 1000 }
      ];

      let hasFish = false;

      sellOptions.forEach(option => {
        const item = inventory.find(i => i.rarity === option.rarity);
        if (item && item.count > 0) {
          hasFish = true;
          shopHTML += `<button onclick="sellFish('${option.rarity}', ${option.price})">Selg ${option.label} (${option.price} gull)</button><br>`;
        }
      });

      if (!hasFish) {
        shopHTML += `<p>Du har ingen fisk å selge.</p>`;
      }

      shopHTML += `<br><button onclick="closeShop()">Lukk</button>`;

      shopBox.innerHTML = shopHTML;
      shopBox.style.display = 'block';
    }

    function closeShop() {
      document.getElementById('shopBox').style.display = 'none';
    }

    function sellFish(rarity, price) {
      const itemIndex = inventory.findIndex(i => i.rarity === rarity);
      if (itemIndex !== -1) {
        inventory[itemIndex].count--;
        gold += price;
        if (inventory[itemIndex].count <= 0) {
          inventory.splice(itemIndex, 1);
        }
        renderInventory();
      }
    }


    function renderInventory() {
      const inv = document.getElementById('inventory');
      inv.innerHTML = `<h3>Inventory</h3><p>Gull: ${gold}</p>`;
      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(5, 64px)';
      grid.style.gap = '8px';

      inventory.forEach(item => {
        const cell = document.createElement('div');
        cell.style.width = '64px';
        cell.style.height = '64px';
        cell.style.background = '#111';
        cell.style.border = '1px solid #666';
        cell.style.display = 'flex';
        cell.style.flexDirection = 'column';
        cell.style.alignItems = 'center';
        cell.style.justifyContent = 'center';
        cell.innerHTML = `<img src="${item.image}" width="32" height="32"><div style="color:white;">x${item.count}</div>`;
        grid.appendChild(cell);
      });

      inv.appendChild(grid);
    }

    function toggleInventory() {
      inventoryOpen = !inventoryOpen;
      document.getElementById('inventory').style.display = inventoryOpen ? 'block' : 'none';
      if (inventoryOpen) renderInventory();
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawCharacter();
    }

    document.addEventListener('keydown', (e) => {
      if (character.moving) return;
      switch (e.key) {
        case 'w': moveCharacter(0, -1); break;
        case 's': moveCharacter(0, 1); break;
        case 'a': moveCharacter(-1, 0); break;
        case 'd': moveCharacter(1, 0); break;
        case 'e': tryInteract(); break;
        case 'i': toggleInventory(); break;
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        toggleMenu();
      }
    });

    function toggleMenu() {
      menuOpen = !menuOpen;
      document.getElementById('gameMenu').style.display = menuOpen ? 'flex' : 'none';
    }

    function closeMenu() {
      menuOpen = false;
      document.getElementById('gameMenu').style.display = 'none';
    }

    function saveGame() {
      const saveData = {
        inventory: inventory,
        level: currentLevel,
        position: {
          x: character.x,
          y: character.y,
          direction: character.direction
        },
        gold: gold
      };

      localStorage.setItem('voidquest_save', JSON.stringify(saveData));
      alert("Spillet er lagret!");
    }

    function loadGame() {
      try {
        const saved = localStorage.getItem('voidquest_save');
        if (saved) {
          const data = JSON.parse(saved);
          inventory = data.inventory || [];

          gold = data.gold || 0;
          const level = data.level ?? 0;
          const x = data.position?.x ?? levels[level].startX;
          const y = data.position?.y ?? levels[level].startY;
          const dir = data.position?.direction ?? 'down';

          character.direction = dir;

          loadLevel(level, x, y);
          renderInventory();
        } else {
          // Ingen lagring funnet – start fra default
          loadLevel(0);
        }
      } catch (e) {
        console.error("Feil ved lasting av lagring:", e);
        loadLevel(0);
      }
    }

    // Prevent movement/inventory while menu is open or fishing
    document.addEventListener('keydown', (e) => {
      if (menuOpen || isFishing) return;
      // Your existing movement + inventory toggle logic here
    });

    loadLevel(1);
    loadGame();
  </script>
</body>
</html>
